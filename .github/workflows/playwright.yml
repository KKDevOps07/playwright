name: Netflix Smoke Tests (Playwright Python)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ---------------------------
    # Docker: Login & Run App
    # ---------------------------
    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Pull Netflix image
      run: |
        docker pull 1819242/netflix:v2

    - name: Run Netflix container
      run: |
        docker run -d -p 8080:80 --name netflix-app 1819242/netflix:v2

    - name: Wait for Netflix app to be ready
      run: |
        echo "Waiting for app..."
        for i in {1..30}; do
          if curl -s http://localhost:8080 > /dev/null; then
            echo "App is up!"
            exit 0
          fi
          sleep 2
        done
        echo "App did not start in time"
        docker logs netflix-app
        exit 1

    # ---------------------------
    # Python + Playwright
    # ---------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest playwright pytest-playwright

    - name: Install Playwright browsers
      run: |
        playwright install --with-deps

    # ---------------------------
    # Run Smoke Tests
    # ---------------------------
    - name: Run smoke tests
      run: |
        pytest tests/smoke-tests/smoke_tests.py 

    # ---------------------------
    # Cleanup
    # ---------------------------
    - name: Stop container
      if: always()
      run: |
        docker stop netflix-app
        docker rm netflix-app
